version: 2.1

jobs:
  build-and-release:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: pip install -r requirements.txt
      - run:
          name: Install GitHub CLI
          command: |
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt-get update
            sudo apt-get install -y gh
      - run:
          name: Clone PostHog website repo
          command: git clone --depth 1 https://github.com/PostHog/posthog.com.git /tmp/posthog.com
      - run:
          name: Build EPUB
          command: |
            mkdir -p output
            python build_epub.py \
              --repo-path /tmp/posthog.com \
              --output output/posthog-handbook.epub
      - store_artifacts:
          path: output/posthog-handbook.epub
          destination: posthog-handbook.epub
      - run:
          name: Create GitHub Release
          command: |
            TAG="$(date -u +%Y-%m)"
            MONTH="$(date -u +'%B %Y')"
            COMMIT="$(git -C /tmp/posthog.com rev-parse --short HEAD)"
            COMMIT_URL="https://github.com/PostHog/posthog.com/commit/$(git -C /tmp/posthog.com rev-parse HEAD)"
            BUILD_DATE="$(date -u +%Y-%m-%d)"

            cat > /tmp/release-notes.md \<< NOTES
            ## PostHog Handbook — ${MONTH} Edition

            Monthly build of the PostHog company handbook as an EPUB e-book.

            **Source:** [PostHog/posthog.com](https://github.com/PostHog/posthog.com)
            **Commit:** [\`${COMMIT}\`](${COMMIT_URL})
            **Built:** ${BUILD_DATE}

            Download the \`.epub\` file below and open it in your favourite e-reader.
            NOTES

            # Delete existing release for this month if re-running
            gh release delete "$TAG" --yes 2>/dev/null || true

            gh release create "$TAG" \
              output/posthog-handbook.epub \
              --title "PostHog Handbook — ${MONTH} Edition" \
              --notes-file /tmp/release-notes.md

workflows:
  monthly-build:
    triggers:
      - schedule:
          cron: "0 9 1 * *"
          filters:
            branches:
              only:
                - main
    jobs:
      - build-and-release

  manual-build:
    jobs:
      - build-and-release:
          filters:
            branches:
              only:
                - main
